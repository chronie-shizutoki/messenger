<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>聊天应用</title>
    <script>
        window.initSocket = function() {
            console.log('[客户端] 开始自动初始化Socket连接');
            if (typeof io === 'undefined') {
                console.error('[客户端] Socket.io未加载');
                updateStatus('Socket.io加载失败', true);
                return;
            }

            // 创建Socket实例并绑定到window
            window.socket = io({
                transports: ['websocket'],
                reconnectionAttempts: 3,
                reconnectionDelay: 1000
            });
            console.log('[客户端] Socket实例已创建:', window.socket);

            // 绑定事件处理函数
            bindSocketEvents();
        }

        // 页面加载完成后自动初始化Socket
        document.addEventListener('DOMContentLoaded', function() {
            console.log('[客户端] 页面加载完成，开始初始化Socket');
            window.initSocket();
        });
    </script>
    <script>
        // 初始化Socket事件
        function initSocketEvents() {
            window.socket.on('connect', () => {
                console.log('[客户端] 已连接到服务器');
                updateStatus('已连接到服务器', false);
            });
            window.socket.on('disconnect', (reason) => {
                console.log('[客户端] 已断开连接:', reason);
                updateStatus('已断开连接: ' + reason, true);
            });
            window.socket.on('connect_error', (error) => {
                console.error('[客户端] 连接错误:', error);
                updateStatus('连接错误: ' + error.message, true);
            });
            window.socket.on('client test', (msg) => {
                console.log('[客户端] 收到服务器测试消息:', msg);
                updateStatus('收到服务器测试消息: ' + msg, false);
            });
        }
    </script>
    <script>
        // 提前定义sendMessage函数
        window.sendMessage = function() {
            try {
                console.log('[客户端] sendMessage函数开始执行 --------------------');
                console.log('[客户端] 当前时间:', new Date().toISOString());
                console.log('[客户端] 当前Socket连接状态:', window.socket?.connected ? '已连接' : '未连接');
                console.log('[客户端] Socket实例状态:', window.socket ? '存在' : '不存在');
                if (!window.socket) {
                    console.error('[客户端] Socket实例未初始化');
                    updateStatus('Socket未初始化，请刷新页面', true);
                    return;
                }
                if (!window.socket.connected) {
                    console.error('[客户端] 发送失败：Socket未连接');
                    updateStatus('未连接到服务器，无法发送消息', true);
                    return;
                }
                const input = document.getElementById('message-input');
                if (!input) {
                    console.error('[客户端] 未找到消息输入框');
                    updateStatus('无法找到输入框', true);
                    return;
                }
                const message = input.value.trim();
                if (!message) {
                    console.log('[客户端] 消息为空，不发送');
                    updateStatus('消息不能为空', true);
                    return;
                }
                console.log('[客户端] 准备发送消息事件: chat message, 内容:', message);
                if (!window.socket) {
                    console.error('[客户端] sendMessage失败: Socket实例未初始化');
                    updateStatus('发送失败: 连接未初始化', true);
                    return;
                }
                window.socket.emit('chat message', {
                    content: message,
                    timestamp: new Date().toISOString()
                }, (error) => {
                    if (error) {
                        console.error('[客户端] 消息发送失败:', error);
                        updateStatus('发送失败: ' + error, true);
                        input.value = message;
                    } else {
                        console.log('[客户端] 消息发送成功');
                        input.value = '';
                        updateStatus('已连接到服务器');
                    }
                });
            } catch (e) {
                console.error('[客户端] sendMessage函数执行异常:', e);
                updateStatus('发送消息时发生异常: ' + e.message, true);
            }
        };

        function updateStatus(message, isError = false) {
            const statusElement = document.getElementById('status-indicator');
            if (statusElement) {
                statusElement.textContent = '状态: ' + message + ' (' + new Date().toLocaleTimeString() + ')';
                statusElement.style.color = isError ? 'red' : 'green';
            }
        }
    </script>
    <style>
        :root {
            --bg-primary: #1a1a1a;
            --bg-secondary: #333333;
            --bg-tertiary: #444444;
            --text-primary: #ffffff;
            --text-secondary: #666666;
            --accent-color: #0066cc;
            --border-color: #444444;
            --spacing-sm: 8px;
            --spacing-md: 16px;
            --spacing-lg: 20px;
            --border-radius: 6px;
            --transition-speed: 0.3s;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Arial', sans-serif;
        }

        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            padding: var(--spacing-sm);
        }

        #status-indicator {
            color: var(--text-secondary);
            padding: var(--spacing-sm);
            font-size: 0.9em;
            text-align: center;
        }

        #chat-container {
            flex: 1;
            padding: var(--spacing-md);
            overflow-y: auto;
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
        }

        .message {
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            padding: var(--spacing-sm) var(--spacing-md);
            margin-bottom: var(--spacing-sm);
            max-width: 70%;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .message .meta {
            font-size: 0.8em;
            color: var(--text-secondary);
            margin-bottom: 2px;
        }

        #input-area {
            display: flex;
            padding: var(--spacing-md);
            max-width: 800px;
            margin: 0 auto;
            width: 90%;
            gap: var(--spacing-sm);
        }

        #message-input {
            flex: 1;
            padding: var(--spacing-sm) var(--spacing-md);
            border: 1px solid var(--border-color);
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 1em;
            border-radius: var(--border-radius);
            transition: border-color var(--transition-speed);
            max-width: 70%;
        }

        #message-input:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        #send-button {
            padding: var(--spacing-sm) var(--spacing-md);
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 1em;
            transition: all var(--transition-speed);
        }

        #send-button:hover {
            background-color: var(--accent-color);
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        #send-button:active {
            transform: translateY(0);
        }

        @media (max-width: 600px) {
            .message {
                max-width: 85%;
            }

            #input-area {
                padding: var(--spacing-sm);
            }
        }
    </style>
</head>
<body>
    <div id="status-indicator" style="color: #666; padding: 10px; font-size: 0.9em;">连接中...</div>
    <div id="chat-container">
    <ul id="messages"></ul>
</div>
    <div id="input-area">
        <input type="text" id="message-input" placeholder="输入消息...">
        <button id="send-button" onclick="window.sendMessage()">发送</button>
    </div>

    <script src="lib/socket.io.js"></script>
    <script src="client.js"></script>
